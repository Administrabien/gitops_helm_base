apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: {{ .Values.name }}
  name: "{{ .Values.name }}-deployment"
  labels:
    app: "{{ .Values.name }}-label" #l
spec:
  replicas: {{ .Values.replicas }}
  revisionHistoryLimit: {{ .Values.revisionsHistoryLimit }}
  selector:
    matchLabels:
      app: "{{ .Values.name }}-label" #l
  template:
    metadata:
      labels:
        app: "{{ .Values.name }}-label" #l
        {{- if.Values.istioEnabled }}
        sidecar.istio.io/inject: "true"
        {{- end }}
        {{- if.Values.canaryEnabled }}
        istio.io/rev: canary
        {{- end }}
    spec:
      containers:
        - name: "{{ .Values.name }}-label" #l
          image:  {{ .Values.global.imgPath }}:{{ .Values.global.appVersion }}
          imagePullPolicy: {{ .Values.container.image.pullPolicy }}
          ports:
            - name: {{ .Values.container.name }}
              containerPort: {{ .Values.container.port }}
              protocol: {{ .Values.container.protocol }}
          env:
          {{- range $key, $val := .Values.container.envs }}
          - name: "{{ $key }}"
            valueFrom:
              secretKeyRef:
                name: "{{ $.Values.name }}-secret"
                key: "{{ $key }}"
          {{- end }}
          {{- if .Values.container.livenessProbe }}
          livenessProbe:
            {{- range $key, $value := .Values.container.livenessProbe }}
            {{- if eq $key "path" }}
            httpGet:
              path: {{ $value }}
              port: http
              scheme: HTTP
            {{- else }}
            {{ $key }}: {{ $value }}
            {{- end }}
            {{- end }}
          {{- end}}
          {{- if .Values.container.readinessProbe }}
          readinessProbe:
            {{- range $key, $value := .Values.container.readinessProbe }}
            {{- if eq $key "path" }}
            httpGet:
              path: {{ $value }}
              port: http
              scheme: HTTP
            {{- else }}
            {{ $key }}: {{ $value }}
            {{- end }}
            {{- end }}
          {{- end}}
          {{- if .Values.container.startupProbe }}
          startupProbe:
            {{- range $key, $value := .Values.container.startupProbe }}
            {{- if eq $key "path" }}
            httpGet:
              path: {{ $value }}
              port: http
              scheme: HTTP
            {{- else }}
            {{ $key }}: {{ $value }}
            {{- end }}
            {{- end }}
          {{- end}}
          {{- with .Values.container.resources }}
          {{- /* Validamos si existe al menos un valor para pintar la secci√≥n 'resources' */ -}}
          {{- if or (or .memory.requests .memory.limits) (or .cpu.requests .cpu.limits) }}
          resources:
              {{- if or .memory.requests .cpu.requests }}
            requests:
                {{- if .memory.requests }}
              memory: {{ .memory.requests | quote }}
                {{- end }}
                {{- if .cpu.requests }}
              cpu: {{ .cpu.requests | quote }}
                {{- end }}
              {{- end }}
              {{- if or .memory.limits .cpu.limits }}
            limits:
                {{- if .memory.limits }}
              memory: {{ .memory.limits | quote }}
                {{- end }}
                {{- if .cpu.limits }}
              cpu: {{ .cpu.limits | quote }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- end }}
