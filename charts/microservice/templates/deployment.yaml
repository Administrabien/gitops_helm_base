apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: {{ .Values.name }}
  name: "{{ .Values.name }}-deployment"
  labels:
    app: "{{ .Values.name }}-label" #l
spec:
  replicas: {{ .Values.replicas }}
  revisionHistoryLimit: {{ .Values.revisionHistoryLimit }}
  selector:
    matchLabels:
      app: "{{ .Values.name }}-label" #l
  template:
    metadata:
      labels:
        app: "{{ .Values.name }}-label" #l
        {{- if.Values.istioEnabled }}
        sidecar.istio.io/inject: "true"
        {{- end }}
        {{- if.Values.canaryEnabled }}
        istio.io/rev: canary
        {{- end }}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "15020"
        prometheus.io/path: "/stats/prometheus"
    spec:
      imagePullSecrets:
        - name: "{{ .Values.name }}-image-pull-secret"
      containers:
        - name: "{{ .Values.name }}-label" #l
          image:  {{ .Values.global.imgPath }}:{{ .Values.global.appVersion }}
          imagePullPolicy: {{ .Values.container.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.container.port }}
              protocol: TCP
          env:
          {{- range $key, $val := .Values.container.envs }}
          - name: "{{ $key }}"
            valueFrom:
              secretKeyRef:
                name: "{{ $.Values.name }}-secret"
                key: "{{ $key }}"
          {{- end }}
          {{- if .Values.container.livenessProbe }}
          livenessProbe:
            {{- range $key, $value := .Values.container.livenessProbe }}
            {{- if eq $key "path" }}
            httpGet:
              path: {{ $value }}
              port: http
              scheme: HTTP
            {{- else }}
            {{ $key }}: {{ $value }}
            {{- end }}
            {{- end }}
          {{- end}}
          {{- if .Values.container.readinessProbe }}
          readinessProbe:
            {{- range $key, $value := .Values.container.readinessProbe }}
            {{- if eq $key "path" }}
            httpGet:
              path: {{ $value }}
              port: http
              scheme: HTTP
            {{- else }}
            {{ $key }}: {{ $value }}
            {{- end }}
            {{- end }}
          {{- end}}
          {{- if .Values.container.startupProbe }}
          startupProbe:
            {{- range $key, $value := .Values.container.startupProbe }}
            {{- if eq $key "path" }}
            httpGet:
              path: {{ $value }}
              port: http
              scheme: HTTP
            {{- else }}
            {{ $key }}: {{ $value }}
            {{- end }}
            {{- end }}
          {{- end}}
          {{- with .Values.container.resources }}
          {{- if or (or .memory.request .memory.limits) (or .cpu.request .cpu.limits) }}
          resources:
              {{- if or .memory.request .cpu.request }}
            requests:
                {{- if .memory.request }}
              memory: {{ .memory.request | quote }}
                {{- end }}
                {{- if .cpu.request }}
              cpu: {{ .cpu.request | quote }}
                {{- end }}
              {{- end }}
              {{- if or .memory.limits .cpu.limits }}
            limits:
                {{- if .memory.limits }}
              memory: {{ .memory.limits | quote }}
                {{- end }}
                {{- if .cpu.limits }}
              cpu: {{ .cpu.limits | quote }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- end }}
      serviceAccountName:  {{ .Values.name}}-sa
      automountServiceAccountToken: {{ .Values.container.autoMountSAToken }}