apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: {{ .Values.microservice.name }}
  name: "{{ .Values.microservice.name }}-deployment"
  labels:
    app: "{{ .Values.microservice.name }}-label" #l
spec:
  replicas: {{ .Values.microservice.replicas }}
  selector:
    matchLabels:
      app: "{{ .Values.microservice.name }}-label" #l
  template:
    metadata:
      labels:
        app: "{{ .Values.microservice.name }}-label" #l
    spec:
      containers:
        - name: "{{ .Values.microservice.name }}-label" #l
          image:  {{ .Values.global.imgPath }}:{{ .Values.global.appVersion }}
          imagePullPolicy: {{ .Values.microservice.container.image.pullPolicy }}
          ports:
            - name: {{ .Values.microservice.container.name }}
              containerPort: {{ .Values.microservice.container.port }}
              protocol: {{ .Values.microservice.container.protocol }}
          env:
          {{- range $key, $val := .Values.microservice.container.envs }}
          - name: "{{ $key }}"
            valueFrom:
              secretKeyRef:
                name: "{{ $.Values.microservice.name }}-secret"
                key: "{{ $key }}"
          {{- end }}